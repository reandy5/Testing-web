<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-N6HN27QS');</script>
<!-- End Google Tag Manager -->
  <meta charset="UTF-8" />
  <title>Checkout</title>
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-N6HN27QS"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
  <h1>Halaman Checkout</h1>

  <label for="coupon">Pilih Kupon:</label>
  <select id="coupon" onchange="applyCoupon()">
    <option value="">-- Tidak Pakai Kupon --</option>
    <option value="DISKON10">DISKON10 - Potongan 10%</option>
    <option value="DISKON50K">DISKON50K - Potongan Rp 50.000</option>
  </select>

  <div id="cart-items"></div>
  <p id="total"></p>
  <button onclick="purchase()">Bayar</button>

  <script>
    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    let selectedCoupon = "";

    // Mapping kupon ke fungsi diskon
    const couponDiscounts = {
      "DISKON10": (price) => price * 0.1,
      "DISKON50K": (price) => 50000
    };

    function applyCoupon() {
      selectedCoupon = document.getElementById("coupon").value;
      renderCart();
    }

    function getDiscountedCartItems() {
      return cart.map((item, index) => {
        const discount = selectedCoupon && couponDiscounts[selectedCoupon]
          ? couponDiscounts[selectedCoupon](item.price)
          : 0;

        return {
          ...item,
          discount: discount,
          coupon: selectedCoupon || undefined,
          index: index
        };
      });
    }

    function getDiscountedTotal() {
      const items = getDiscountedCartItems();
      return items.reduce((sum, item) => sum + (item.price - (item.discount || 0)) * item.quantity, 0);
    }

    function renderCart() {
      const el = document.getElementById("cart-items");
      const totalEl = document.getElementById("total");

      if (cart.length === 0) {
        el.innerHTML = "<p>Keranjang kosong.</p>";
        totalEl.innerHTML = "";
        return;
      }

      let html = "<ul>";
      getDiscountedCartItems().forEach(item => {
        const finalPrice = item.price - (item.discount || 0);
        html += `<li>${item.item_name} - Qty: ${item.quantity} - Rp ${item.price} - Diskon: Rp ${item.discount || 0} - Total: Rp ${finalPrice * item.quantity}</li>`;
      });
      html += "</ul>";
      el.innerHTML = html;

      totalEl.innerHTML = `<strong>Total Bayar: Rp ${getDiscountedTotal()}</strong>`;
    }

    // Push begin_checkout event
    window.dataLayer = window.dataLayer || [];
    if (cart.length > 0) {
      const items = getDiscountedCartItems();
      const total = getDiscountedTotal();

      window.dataLayer.push({
        event: "begin_checkout",
        ecommerce: {
          currency: "IDR",
          value: total,
          coupon: selectedCoupon || undefined,
          items: items
        }
      });
    }

    function purchase() {
      if (cart.length === 0) {
        alert("Keranjang kosong.");
        return;
      }

      const discountedItems = getDiscountedCartItems();

      const purchaseData = {
        transaction_id: Date.now().toString(),
        currency: "IDR",
        items: discountedItems,
        value: getDiscountedTotal(),
        coupon: selectedCoupon || undefined
      };

      sessionStorage.setItem("purchaseData", JSON.stringify(purchaseData));
      localStorage.removeItem("cart");
      window.location.href = "success.html";
    }

    renderCart();
  </script>
</body>
</html>
